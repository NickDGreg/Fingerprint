name: Build and Deploy Worker

on:
  push:
    branches:
      - main
      - dev
      - develop

concurrency:
  group: fingerprint-deploy-${{ github.ref_name == 'main' && 'prod' || 'dev' }}
  cancel-in-progress: true

permissions:
  contents: read
  packages: write

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      deploy_env: ${{ steps.target.outputs.deploy_env }}
      deploy_dir: ${{ steps.target.outputs.deploy_dir }}
      sha_short: ${{ steps.vars.outputs.sha_short }}
      image_tag: ${{ steps.tags.outputs.image_tag }}
      latest_tag: ${{ steps.tags.outputs.latest_tag }}
    steps:
      - uses: actions/checkout@v4
      - name: Resolve deployment target
        id: target
        run: |
          case "${GITHUB_REF_NAME}" in
            main)
              DEPLOY_ENV="prod"
              ;;
            dev|develop)
              DEPLOY_ENV="dev"
              ;;
            *)
              echo "Unsupported branch for deployment: ${GITHUB_REF_NAME}"
              exit 1
              ;;
          esac
          echo "deploy_env=${DEPLOY_ENV}" >> "$GITHUB_OUTPUT"
          echo "deploy_dir=/home/github/fingerprint-${DEPLOY_ENV}" >> "$GITHUB_OUTPUT"
      - name: Set image name
        run: echo "IMAGE_NAME=ghcr.io/${GITHUB_REPOSITORY,,}" >> "$GITHUB_ENV"
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set short git commit SHA
        id: vars
        run: echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
      - name: Set image tags
        id: tags
        run: |
          IMAGE_TAG="${{ steps.vars.outputs.sha_short }}-${{ steps.target.outputs.deploy_env }}"
          LATEST_TAG="latest-${{ steps.target.outputs.deploy_env }}"
          echo "image_tag=${IMAGE_TAG}" >> "$GITHUB_OUTPUT"
          echo "latest_tag=${LATEST_TAG}" >> "$GITHUB_OUTPUT"
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.IMAGE_NAME }}:${{ steps.tags.outputs.latest_tag }}
            ${{ env.IMAGE_NAME }}:${{ steps.tags.outputs.image_tag }}

  deploy:
    runs-on: ubuntu-latest
    needs: build
    env:
      VM_IP: ${{ needs.build.outputs.deploy_env == 'prod' && (secrets.PROD_VM_IP || secrets.VM_IP) || (secrets.DEV_VM_IP || secrets.VM_IP) }}
      SSH_PRIVATE_KEY: ${{ needs.build.outputs.deploy_env == 'prod' && (secrets.PROD_SSH_PRIVATE_KEY || secrets.SSH_PRIVATE_KEY) || (secrets.DEV_SSH_PRIVATE_KEY || secrets.SSH_PRIVATE_KEY) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set image name
        run: echo "IMAGE_NAME=ghcr.io/${GITHUB_REPOSITORY,,}" >> "$GITHUB_ENV"

      - name: Validate deployment secrets
        run: |
          test -n "${VM_IP}" || (echo "Missing VM IP secret." && exit 1)
          test -n "${SSH_PRIVATE_KEY}" || (echo "Missing SSH private key secret." && exit 1)

      - name: Prepare SSH
        run: |
          mkdir -p ~/.ssh
          echo "${SSH_PRIVATE_KEY}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "${VM_IP}" >> ~/.ssh/known_hosts

      - name: Ensure deployment directory
        run: ssh github@"${VM_IP}" "mkdir -p '${{ needs.build.outputs.deploy_dir }}'"

      - name: Upload compose.yml
        run: scp compose.yml github@"${VM_IP}":"${{ needs.build.outputs.deploy_dir }}/compose.yml"

      - name: Deploy
        run: |
          IMAGE_NAME="${{ env.IMAGE_NAME }}"
          IMAGE_TAG="${{ needs.build.outputs.image_tag }}"
          DEPLOY_DIR="${{ needs.build.outputs.deploy_dir }}"
          DEPLOY_ENV="${{ needs.build.outputs.deploy_env }}"

          ssh github@"${VM_IP}" "
            cd '${DEPLOY_DIR}' && \
            IMAGE_NAME=$IMAGE_NAME IMAGE_TAG=$IMAGE_TAG docker compose pull && \
            IMAGE_NAME=$IMAGE_NAME IMAGE_TAG=$IMAGE_TAG docker compose up -d
          "
          echo "Deployed ${IMAGE_NAME}:${IMAGE_TAG} to ${DEPLOY_ENV} (${DEPLOY_DIR})"
